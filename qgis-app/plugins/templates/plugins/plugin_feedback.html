{% extends 'plugins/plugin_base.html' %}{% load i18n %}
{% block content %}
    <h2>{% trans "Feedback Plugin" %} {{ version.plugin.name }} {{ version.version }}</h2>
    {% if form.errors %}
    <div class="alert alert-error">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <p>{% trans "The form contains errors and cannot be submitted, please check the fields highlighted in red." %}</p>
    </div>
    {% endif %}
    {% if form.non_field_errors %}
    <div class="alert alert-error">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
        {% endfor %}
    </div>
    {% endif %}
    <div>
        {% for feedback in feedbacks %}
        <div>
            <div class="span8 previous-feedback" data-feedback-id="{{ feedback.id }}">
                <div class="previous-feedback-header">
                    <!-- Checkbox for status -->
                    <input type="checkbox" class="statusCheckbox pull-left" name="statusCheckbox" data-feedback-id="{{ feedback.id }}" {% if feedback.is_completed %}checked{% endif %}>

                    {% if feedback.reviewer in version.plugin.editors %}<b>[Owner]</b> {% endif %}
                    <b>{% if feedback.reviewer.first_name %}{{ feedback.reviewer.first_name }} {{ feedback.reviewer.last_name }}{% else %}{{ feedback.reviewer.username }}{% endif %}</b>
                    gave feedback {{ feedback.created_on|timesince }} ago

                    {% if feedback.reviewer == request.user %}
                    <!-- Delete button -->
                    <button type="button" class="btn btn-danger btn-mini deleteButton pull-right" data-feedback-id="{{ feedback.id }}"><i class="icon-remove"></i></button>
                    {% endif %}
                </div>
                <p>{{ feedback.task }}</p>
            </div>
        </div>
        {% endfor %}

        {% if is_user_has_approval_rights %}
        <div>
            <div class="span8 new-feedback">
                <form method="post" action="{% url 'version_feedback' version.plugin.package_name version.version %}">{% csrf_token %}
                    <b>Feedback</b>
                        {{ form.feedback }}
                        <div class="text-right">
                            <button class="btn btn-primary" type="submit">{% trans "Submit Feedback" %}</button>
                        </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>

{% endblock %}

{% block extrajs %}
    <style>
    .new-feedback{
        background-color: lightgray;
        padding: 5px;
        border-radius: 5px;
        margin-top: 20px;
        margin-bottom: 5px;
    }
    .previous-feedback{
        border: 1px solid #e8e8e8;
        padding: 5px;
        border-radius: 5px;
        margin-top: 5px;
    }
    .previous-feedback-header{
        background-color: #e8e8e8;
        padding: 5px;
        border-radius: 2px;
        margin: -5px -5px 0;
    }
    input.statusCheckbox{
        margin-right: 5px;
    }

    </style>

    <script>
    $(document).ready(function(){
        const url = window.location.href;
        // Checkbox click event
        $('.statusCheckbox').on('click', function() {
            const checkbox = $(this);
            const feedbackId = checkbox.data('feedback-id');
            const status = checkbox.is(':checked') ? 'completed' : 'uncompleted';
            const formData = {
              'status_feedback': status,
              'csrfmiddlewaretoken': '{{ csrf_token }}'
            };
            console.log("checkbox: ", feedbackId, status);
            updateStatus(feedbackId, formData);
        });

        // Delete button click event
        $('.deleteButton').on('click', function() {
          const button = $(this);
          const feedbackId = button.data('feedback-id');
          const formData = {
              'status_feedback': "deleted",
              'csrfmiddlewaretoken': '{{ csrf_token }}'
            };
          console.log("deleted: ", feedbackId);
          deleteFeedback(feedbackId, formData);
        });

        // Function to update status
        function updateStatus(feedbackId, formData) {
            $.ajax({
                type: 'POST',
                url: url + feedbackId + '/',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        console.log("succeed updated feedback:", feedbackId)
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error('Error updating status:', errorThrown);
                }
            });
        }

        // Function to delete feedback
        function deleteFeedback(feedbackId, formData) {
            const msg = "This task will be permanently deleted. Please confirm."
            if (confirm(msg)) {
                $.ajax({
                    type: 'POST',
                    url: url + feedbackId + '/',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            const feedbackItem = $('.previous-feedback[data-feedback-id="' + feedbackId + '"]');
                            feedbackItem.remove();
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.error('Error updating status:', errorThrown);
                    }
                });
            }
        }
    })
    </script>
{% endblock %}